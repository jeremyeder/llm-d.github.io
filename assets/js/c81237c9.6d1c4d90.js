"use strict";(self.webpackChunkdocusaurus_test=self.webpackChunkdocusaurus_test||[]).push([[3837],{1262:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"architecture/Component Architecture/routing-sidecar","title":"P/D Routing Sidecar","description":"This project provides a reverse proxy redirecting incoming requests","source":"@site/docs/architecture/Component Architecture/05_routing-sidecar.md","sourceDirName":"architecture/Component Architecture","slug":"/architecture/Component Architecture/routing-sidecar","permalink":"/docs/architecture/Component Architecture/routing-sidecar","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"sidebar_position":5,"sidebar_label":"Routing Sidecar"},"sidebar":"structureSidebar","previous":{"title":"Disagg Prefill/Decode","permalink":"/docs/architecture/Component Architecture/disagg_prefill-decode"}}');var i=n(4848),o=n(8453);const s={sidebar_position:5,sidebar_label:"Routing Sidecar"},c="P/D Routing Sidecar",l={},d=[{value:"Getting Started",id:"getting-started",level:2},{value:"Requirements",id:"requirements",level:3},{value:"Quick Start (From source)",id:"quick-start-from-source",level:3},{value:"License",id:"license",level:2}];function a(e){const r={a:"a",blockquote:"blockquote",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(r.header,{children:(0,i.jsx)(r.h1,{id:"pd-routing-sidecar",children:"P/D Routing Sidecar"})}),"\n",(0,i.jsxs)(r.p,{children:["This project provides a reverse proxy redirecting incoming requests\r\nto the prefill worker specified in the ",(0,i.jsx)(r.code,{children:"x-prefiller-url"})," HTTP request header."]}),"\n",(0,i.jsx)(r.p,{children:"This is a prototype of a vLLM-native protocol for disaggregated serving. The\r\ninference scheduler determines the best decode worker when it determines the\r\nprefill worker, then informs the prefill worker where to direct the K/V transfer\r\nas a single transaction. This ensures request cancellation or failures release\r\nresources on both workers promptly."}),"\n",(0,i.jsxs)(r.p,{children:["See the ",(0,i.jsx)(r.a,{href:"https://docs.google.com/document/d/1FNN5snmipaTxEA1FGEeSH7Z_kEqskouKD1XYhVyTHr8/edit?tab=t.0#heading=h.ycwld2oth1kj",children:"disaggregated serving Northstar"})," for more."]}),"\n",(0,i.jsx)(r.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,i.jsx)(r.h3,{id:"requirements",children:"Requirements"}),"\n",(0,i.jsxs)(r.ul,{children:["\n",(0,i.jsx)(r.li,{children:"a container engine (docker, podman, etc...)"}),"\n",(0,i.jsx)(r.li,{children:"a server with at least 2 GPUs"}),"\n"]}),"\n",(0,i.jsx)(r.h3,{id:"quick-start-from-source",children:"Quick Start (From source)"}),"\n",(0,i.jsxs)(r.ol,{children:["\n",(0,i.jsx)(r.li,{children:"Start two vLLM servers with P/D enabled via the NIXLConnector."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"In one terminal, run this command to start the decoder:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'$ podman run --network host --device nvidia.com/gpu=0 -v $HOME/models:/models \\\r\n    -e UCX_TLS="cuda_ipc,cuda_copy,tcp" \\\r\n    -e VLLM_NIXL_SIDE_CHANNEL_PORT=5555 \\\r\n    -e VLLM_NIXL_SIDE_CHANNEL_HOST=localhost \\\r\n    -e VLLM_LOGGING_LEVEL=DEBUG \\\r\n    -e HF_HOME=/models ghcr.io/llm-d/llm-d:0.0.8 --model Qwen/Qwen3-0.6B \\\r\n    --enforce-eager \\\r\n    --port 8001 \\\r\n    --kv-transfer-config=\'{"kv_connector":"NixlConnector","kv_role":"kv_both"}\'\n'})}),"\n",(0,i.jsx)(r.p,{children:"In another terminal, run this command to start the prefiller:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'$ podman run --network host --device nvidia.com/gpu=1 -v $HOME/models:/models \\\r\n    -e UCX_TLS="cuda_ipc,cuda_copy,tcp" \\\r\n    -e VLLM_NIXL_SIDE_CHANNEL_PORT=5556 \\\r\n    -e VLLM_NIXL_SIDE_CHANNEL_HOST=localhost \\\r\n    -e VLLM_LOGGING_LEVEL=DEBUG \\\r\n    -e HF_HOME=/models ghcr.io/llm-d/llm-d:0.0.8 --model Qwen/Qwen3-0.6B \\\r\n    --enforce-eager \\\r\n    --port 8002 \\\r\n    --kv-transfer-config=\'{"kv_connector":"NixlConnector","kv_role":"kv_both"}\'\n'})}),"\n",(0,i.jsxs)(r.ol,{start:"2",children:["\n",(0,i.jsx)(r.li,{children:"Clone and start the routing proxy."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"In another terminal, clone this repository and build the routing proxy:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"$ git clone https://github.com/llm-d/llm-d-routing-sidecar.git && \\\r\n  cd llm-d-routing-sidecar && \\\r\n  make build\n"})}),"\n",(0,i.jsx)(r.p,{children:"In the same terminal, start the routing proxy:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"$ ./bin/llm-d-routing-sidecar -port=8000 -vllm-port=8001 -connector=nixlv2\n"})}),"\n",(0,i.jsxs)(r.ol,{start:"3",children:["\n",(0,i.jsx)(r.li,{children:"Send a request."}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Finally, in another terminal, send a chat completions request to the router proxy on port 8000 and tell it to use the prefiller on port 8002:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'$ curl  http://localhost:8000/v1/completions \\\r\n      -H "Content-Type: application/json" \\\r\n      -H "x-prefiller-url: http://localhost:8002" \\\r\n       -d \'{\r\n        "model": "Qwen/Qwen3-0.6B",\r\n        "prompt": "Author-contribution statements and acknowledgements in research papers should state clearly and specifically whether, and to what extent, the authors used AI technologies such as ChatGPT in the preparation of their manuscript and analysis. They should also indicate which LLMs were used. This will alert editors and reviewers to scrutinize manuscripts more carefully for potential biases, inaccuracies and improper source crediting. Likewise, scientific journals should be transparent about their use of LLMs, for example when selecting submitted manuscripts. Mention the large language model based product mentioned in the paragraph above:"\r\n      }\'\n'})}),"\n",(0,i.jsxs)(r.ol,{start:"4",children:["\n",(0,i.jsx)(r.li,{children:"Verification"}),"\n"]}),"\n",(0,i.jsx)(r.p,{children:"Observe the request is processed by both the prefiller and then the decoder:"}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.em,{children:"Prefiller logs (trimmed for clarity purpose):"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"...\r\nReceived request cmpl-386a7566-31a0-11f0-b783-0200017aca02-0: prompt: ...\r\n...\r\nNIXLConnector request_finished, request_status=7 ...\n"})}),"\n",(0,i.jsx)(r.p,{children:(0,i.jsx)(r.em,{children:"Decoder logs (trimmed for clarity purpose):"})}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:"...\r\nReceived request cmpl-386a7566-31a0-11f0-b783-0200017aca02-0: prompt: ...\r\n...\r\nDEBUG 05-15 15:21:06 [nixl_connector.py:646] start_load_kv for request cmpl-386a7566-31a0-11f0-b783-0200017aca02-0 from remote engine c53ac287-36cd-4b52-811f-16de4e4bd3a5. Num local_block_ids: 6. Num remote_block_ids: 6\r\n...\r\n\r\n## Development\r\n\r\n### Building the routing proxy\r\n\r\nBuild the routing proxy from source:\r\n\r\n```sh\r\n$ make build\n"})}),"\n",(0,i.jsx)(r.p,{children:"Check the build was successful by running it locally:"}),"\n",(0,i.jsx)(r.pre,{children:(0,i.jsx)(r.code,{children:'$ ./bin/llm-d-routing-sidecar -help\r\nUsage of ./bin/llm-d-routing-sidecar:\r\n  -connector string\r\n        the P/D connector being used. Either nixl, nixlv2 or lmcache (default "nixl")\r\n  -port string\r\n        the port the sidecar is listening on (default "8000")\r\n  -vllm-port string\r\n        the port vLLM is listening on (default "8001")\r\n...\n'})}),"\n",(0,i.jsxs)(r.blockquote,{children:["\n",(0,i.jsxs)(r.p,{children:[(0,i.jsx)(r.strong,{children:"Note:"})," lmcache connector is deprecated."]}),"\n"]}),"\n",(0,i.jsx)(r.h2,{id:"license",children:"License"}),"\n",(0,i.jsxs)(r.p,{children:["This project is licensed under the Apache License 2.0. See the ",(0,i.jsx)(r.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:n(3004).A+"",children:"LICENSE"})," file for details."]})]})}function h(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,i.jsx)(r,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},3004:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/files/LICENSE-fdbee52198bec4efcc81c1595d558aae.bin"},8453:(e,r,n)=>{n.d(r,{R:()=>s,x:()=>c});var t=n(6540);const i={},o=t.createContext(i);function s(e){const r=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function c(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:s(e.components),t.createElement(o.Provider,{value:r},e.children)}}}]);